<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="theme-color" content="#007AFF" />
  <title>Habit Journal</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <!-- Welcome Modal -->
  <div id="welcome-modal" class="modal" style="display: none;">
    <div class="modal-content welcome-modal-content">
      <div class="welcome-header">
        <h1>Welcome!</h1>
        <p>Let's get started</p>
      </div>
      <div class="modal-body">
        <div class="card">
          <label for="user-name-input">What's your name?</label>
          <input type="text" id="user-name-input" placeholder="Enter your name" maxlength="50" />
        </div>
        <button class="save-btn" id="save-name-btn">Continue</button>
      </div>
    </div>
  </div>

  <!-- Mood Prompt Modal -->
  <div id="mood-prompt-modal" class="modal" style="display: none;">
    <div class="modal-content mood-prompt-content">
      <div class="modal-header">
        <h2>How are you feeling today?</h2>
      </div>
      <div class="modal-body">
        <div class="mood-prompt-container">
          <div class="mood-slider-container">
            <div class="mood-bar-container">
              <div class="mood-bar" id="mood-prompt-bar">
                <div class="mood-bar-fill" id="mood-prompt-bar-fill"></div>
              </div>
              <input type="range" id="mood-prompt-input" min="1" max="10" value="5" />
            </div>
            <div class="mood-value-large" id="mood-prompt-value">5</div>
          </div>
          <button class="save-btn" id="save-mood-prompt-btn">Save Mood</button>
          <button class="skip-btn" id="skip-mood-btn">Skip</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Today Tab -->
  <div id="today-tab" class="tab-content active">
    <div class="page-header">
      <h1 id="welcome-title">Today</h1>
      <div class="date-display" id="today-date"></div>
    </div>

    <div class="card">
      <label for="mood-input">Mood (1-10)</label>
      <div class="mood-container">
        <div class="mood-bar-container">
          <div class="mood-bar" id="mood-bar">
            <div class="mood-bar-fill" id="mood-bar-fill"></div>
          </div>
          <input type="range" id="mood-input" min="1" max="10" value="5" />
        </div>
        <div class="mood-value" id="mood-value">5</div>
      </div>
    </div>

    <div class="card">
      <label for="highlight-input">Highlight of the Day</label>
      <input type="text" id="highlight-input" placeholder="What made today special?" />
    </div>

    <div class="card" id="habits-card" style="display: none;">
      <label>Habits</label>
      <div id="habits-checklist"></div>
      <div class="empty-state" id="habits-empty" style="display: none;">
        <p>No habits yet. Tap + to add habits!</p>
      </div>
    </div>

    <div class="card">
      <label for="journal-input">Journal</label>
      <textarea id="journal-input" rows="6" placeholder="Write about your day..."></textarea>
    </div>

    <div class="card" id="screen-time-card" style="display: none;">
      <label for="screen-time-input">Screen Time (minutes)</label>
      <div class="screen-time-container">
        <input type="number" id="screen-time-input" placeholder="Optional" min="0" />
        <button type="button" class="helper-btn" id="screen-time-help">How to find</button>
      </div>
      <div id="screen-time-instructions" class="helper-text" style="display: none;">
        <p>To find your Screen Time:</p>
        <ol>
          <li>Open Settings app</li>
          <li>Tap "Screen Time"</li>
          <li>View today's total at the top</li>
        </ol>
      </div>
    </div>

    <div class="card" id="weight-card" style="display: none;">
      <label for="weight-input">Weight (lbs)</label>
      <input type="number" id="weight-input" placeholder="Enter your weight" min="0" step="0.1" />
    </div>

    <button class="add-feature-btn" id="add-feature-btn">
      <span class="add-icon">+</span>
      <span>Add Feature</span>
    </button>

    <div id="save-status" class="save-status"></div>
  </div>

  <!-- Add Feature Modal -->
  <div id="add-feature-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Feature</h2>
        <button class="close-btn" id="close-add-feature-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="feature-options">
          <button class="feature-option-btn" id="add-habits-feature">
            <span class="feature-icon">‚úì</span>
            <div>
              <div class="feature-title">Habits</div>
              <div class="feature-desc">Track daily habits</div>
            </div>
          </button>
          <button class="feature-option-btn" id="add-weight-feature">
            <span class="feature-icon">‚öñÔ∏è</span>
            <div>
              <div class="feature-title">Weight Tracker</div>
              <div class="feature-desc">Track your weight</div>
            </div>
          </button>
          <button class="feature-option-btn" id="add-screen-time-feature">
            <span class="feature-icon">üì±</span>
            <div>
              <div class="feature-title">Screen Time</div>
              <div class="feature-desc">Track daily screen time</div>
            </div>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Manage Habits Modal -->
  <div id="manage-habits-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Manage Habits</h2>
        <button class="close-btn" id="close-manage-habits-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="card">
          <div class="add-habit-container">
            <input type="text" id="new-habit-input" placeholder="Enter habit name" />
            <button class="add-btn" id="add-habit-btn">Add</button>
          </div>
        </div>
        <div id="habits-list" class="habits-list"></div>
        <div class="empty-state" id="habits-list-empty" style="display: none;">
          <p>No habits yet. Add your first habit above!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Tab -->
  <div id="stats-tab" class="tab-content">
    <div class="page-header">
      <h1>Stats</h1>
    </div>

    <div class="card">
      <h2>Habit Completion</h2>
      <div id="habit-stats-container"></div>
    </div>

    <div class="card">
      <h2>Mood Trend (Last 30 Days)</h2>
      <canvas id="mood-chart"></canvas>
    </div>

    <div class="card" id="weight-chart-card" style="display: none;">
      <h2>Weight Trend (Last 30 Days)</h2>
      <canvas id="weight-chart"></canvas>
    </div>

    <div class="card">
      <h2>Journal Consistency</h2>
      <div id="journal-consistency"></div>
    </div>

  <div class="card">
      <h2>Most Consistent Habits</h2>
      <div id="most-consistent-habits"></div>
    </div>
  </div>

  <!-- History Tab -->
  <div id="history-tab" class="tab-content">
    <div class="page-header">
      <h1>History</h1>
      <button class="settings-icon-btn" id="top-habits-settings-btn" title="Set Top 3 Habits">‚öôÔ∏è</button>
    </div>

    <div class="card" id="top-habits-settings-card" style="display: none;">
      <h3>Select Top 3 Habits for History View</h3>
      <div id="top-habits-selection"></div>
      <button class="save-btn" id="save-top-habits-btn" style="margin-top: 12px;">Save</button>
    </div>

    <div id="history-list" class="history-list-compact"></div>
    <div class="empty-state" id="history-empty" style="display: none;">
      <p>No entries yet. Start by adding your first entry in the Today tab!</p>
    </div>
  </div>

  <!-- History Entry Detail Modal -->
  <div id="history-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-date"></h2>
        <button class="close-btn" id="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="card">
          <label>Mood</label>
          <div id="modal-mood"></div>
        </div>
        <div class="card">
          <label>Highlight</label>
          <div id="modal-highlight"></div>
        </div>
        <div class="card">
          <label>Habits</label>
          <div id="modal-habits"></div>
        </div>
        <div class="card">
          <label>Journal</label>
          <div id="modal-journal"></div>
        </div>
        <div class="card">
          <label>Screen Time</label>
          <div id="modal-screen-time"></div>
        </div>
        <button class="save-btn" id="edit-entry-btn">Edit Entry</button>
      </div>
    </div>
  </div>

  <!-- Edit Entry Modal -->
  <div id="edit-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="edit-modal-date"></h2>
        <button class="close-btn" id="close-edit-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="card">
          <label for="edit-mood-input">Mood (1-10)</label>
          <div class="mood-container">
            <input type="range" id="edit-mood-input" min="1" max="10" value="5" />
            <div class="mood-value" id="edit-mood-value">5</div>
          </div>
        </div>
        <div class="card">
          <label for="edit-highlight-input">Highlight</label>
          <input type="text" id="edit-highlight-input" />
        </div>
        <div class="card">
          <label>Habits</label>
          <div id="edit-habits-checklist"></div>
        </div>
        <div class="card">
          <label for="edit-journal-input">Journal</label>
          <textarea id="edit-journal-input" rows="6"></textarea>
        </div>
        <div class="card">
          <label for="edit-screen-time-input">Screen Time (minutes)</label>
          <input type="number" id="edit-screen-time-input" min="0" />
        </div>
        <button class="save-btn" id="save-edit-btn">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Habit Edit Modal -->
  <div id="habit-edit-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Habit</h2>
        <button class="close-btn" id="close-habit-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="card">
          <label for="edit-habit-name-input">Habit Name</label>
          <input type="text" id="edit-habit-name-input" />
        </div>
        <button class="save-btn" id="save-habit-edit-btn">Save</button>
        <button class="delete-btn" id="delete-habit-btn">Delete Habit</button>
      </div>
    </div>
  </div>

  <!-- Bottom Tab Bar -->
  <nav class="tab-bar">
    <button class="tab-btn active" data-tab="today">
      <span class="tab-icon">üìÖ</span>
      <span class="tab-label">Today</span>
    </button>
    <button class="tab-btn" data-tab="stats">
      <span class="tab-icon">üìä</span>
      <span class="tab-label">Stats</span>
    </button>
    <button class="tab-btn" data-tab="history">
      <span class="tab-icon">üìú</span>
      <span class="tab-label">History</span>
    </button>
    <button class="tab-btn" data-tab="settings">
      <span class="tab-icon">‚öôÔ∏è</span>
      <span class="tab-label">Settings</span>
    </button>
  </nav>

  <!-- Settings Tab -->
  <div id="settings-tab" class="tab-content">
    <div class="page-header">
      <h1>Settings</h1>
    </div>

    <div class="card">
      <h2>Export Data</h2>
      <p>Download all your data as a JSON file for backup.</p>
      <button class="save-btn" id="export-btn">Export Data</button>
    </div>

    <div class="card">
      <h2>Import Data</h2>
      <p>Restore your data from a previously exported JSON file.</p>
      <input type="file" id="import-file" accept=".json" style="display: none;" />
      <button class="save-btn" id="import-btn">Import Data</button>
      <div id="import-status" class="save-status"></div>
    </div>

    <div class="card">
      <h2>Reset Data</h2>
      <p>Permanently delete all habits and entries. This cannot be undone.</p>
      <button class="delete-btn" id="reset-btn">Reset All Data</button>
  </div>

    <div class="card">
      <h2>Preferences</h2>
      <div class="preference-item">
        <label class="switch">
          <input type="checkbox" id="pref-screen-time" />
          <span class="slider"></span>
        </label>
        <div class="preference-label">
          <span class="preference-title">Show Screen Time</span>
          <span class="preference-desc">Display screen time field in Today tab</span>
        </div>
      </div>
      <div class="preference-item">
        <label class="switch">
          <input type="checkbox" id="pref-weight" />
          <span class="slider"></span>
        </label>
        <div class="preference-label">
          <span class="preference-title">Show Weight Tracker</span>
          <span class="preference-desc">Display weight field in Today tab</span>
        </div>
      </div>
      <div class="preference-item">
        <label class="switch">
          <input type="checkbox" id="pref-mood-prompt" />
          <span class="slider"></span>
        </label>
        <div class="preference-label">
          <span class="preference-title">Prompt for Mood on Open</span>
          <span class="preference-desc">Ask for mood when app opens</span>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>Your Name</h2>
      <input type="text" id="settings-name-input" placeholder="Enter your name" maxlength="50" />
      <button class="save-btn" id="save-settings-name-btn" style="margin-top: 12px;">Save Name</button>
    </div>

    <div class="card">
      <h2>Config URL</h2>
      <p>For iOS Shortcuts automation (optional).</p>
      <input type="text" id="config-url-input" placeholder="https://username.github.io/repo/config.json" />
      <button class="save-btn" id="save-config-url-btn">Save URL</button>
      <div id="config-url-status" class="save-status"></div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    // Global state
    let currentEditingDate = null;
    let currentEditingHabitId = null;
    let moodChart = null;
    let weightChart = null;
    let userPreferences = null;
    let saveTimeout = null;
    let topHabits = [null, null, null]; // Top 3 habits for history view

    // Initialize app
    async function init() {
      try {
        await initDB();
        userPreferences = await getPreferences();
        setupEventListeners();
        await checkWelcomeScreen();
        await loadPreferences();
        await updateWelcomeTitle();
        loadTodayPage();
        updateTabBar();
        await checkMoodPrompt();
      } catch (error) {
        console.error('Initialization error:', error);
        alert('Failed to initialize app: ' + error.message);
      }
    }

    async function checkWelcomeScreen() {
      const prefs = await getPreferences();
      if (!prefs.userName || prefs.userName.trim() === '') {
        document.getElementById('welcome-modal').style.display = 'flex';
      }
    }

    async function checkMoodPrompt() {
      const prefs = await getPreferences();
      if (prefs.promptMoodOnOpen) {
        const today = getTodayDate();
        const entry = await getEntry(today);
        if (!entry || entry.mood === null || entry.mood === undefined) {
          document.getElementById('mood-prompt-modal').style.display = 'flex';
        }
      }
    }

    async function loadPreferences() {
      const prefs = await getPreferences();
      userPreferences = prefs;
      
      // Update UI based on preferences
      document.getElementById('screen-time-card').style.display = prefs.showScreenTime ? 'block' : 'none';
      document.getElementById('weight-card').style.display = prefs.showWeight ? 'block' : 'none';
      document.getElementById('habits-card').style.display = prefs.showHabits ? 'block' : 'none';
      
      // Update settings checkboxes
      document.getElementById('pref-screen-time').checked = prefs.showScreenTime;
      document.getElementById('pref-weight').checked = prefs.showWeight;
      document.getElementById('pref-mood-prompt').checked = prefs.promptMoodOnOpen;
      document.getElementById('settings-name-input').value = prefs.userName || '';
      
      // Load top habits
      topHabits = prefs.topHabits || [null, null, null];
    }

    async function updateWelcomeTitle() {
      const prefs = await getPreferences();
      const titleEl = document.getElementById('welcome-title');
      if (prefs.userName && prefs.userName.trim() !== '') {
        titleEl.textContent = `Welcome, ${prefs.userName}!`;
      } else {
        titleEl.textContent = 'Today';
      }
    }

    // Tab navigation
    function setupEventListeners() {
      // Tab bar buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tab = btn.dataset.tab;
          switchTab(tab);
        });
      });

      // Today page
      document.getElementById('mood-input').addEventListener('input', (e) => {
        const value = e.target.value;
        document.getElementById('mood-value').textContent = value;
        updateMoodBar('mood-bar', 'mood-bar-fill', value);
        debounceSave();
      });
      document.getElementById('highlight-input').addEventListener('input', debounceSave);
      document.getElementById('journal-input').addEventListener('input', debounceSave);
      document.getElementById('screen-time-input').addEventListener('input', debounceSave);
      document.getElementById('weight-input').addEventListener('input', debounceSave);
      document.getElementById('screen-time-help').addEventListener('click', () => {
        const instructions = document.getElementById('screen-time-instructions');
        instructions.style.display = instructions.style.display === 'none' ? 'block' : 'none';
      });

      // Add feature button
      document.getElementById('add-feature-btn').addEventListener('click', () => {
        document.getElementById('add-feature-modal').style.display = 'flex';
      });
      document.getElementById('close-add-feature-modal').addEventListener('click', () => {
        document.getElementById('add-feature-modal').style.display = 'none';
      });
      document.getElementById('add-habits-feature').addEventListener('click', () => {
        document.getElementById('add-feature-modal').style.display = 'none';
        document.getElementById('habits-card').style.display = 'block';
        setPreference('showHabits', true);
        loadTodayPage();
      });
      document.getElementById('add-weight-feature').addEventListener('click', () => {
        document.getElementById('add-feature-modal').style.display = 'none';
        document.getElementById('weight-card').style.display = 'block';
        setPreference('showWeight', true);
        document.getElementById('pref-weight').checked = true;
      });
      document.getElementById('add-screen-time-feature').addEventListener('click', () => {
        document.getElementById('add-feature-modal').style.display = 'none';
        document.getElementById('screen-time-card').style.display = 'block';
        setPreference('showScreenTime', true);
        document.getElementById('pref-screen-time').checked = true;
      });

      // Manage habits
      document.getElementById('close-manage-habits-modal').addEventListener('click', () => {
        document.getElementById('manage-habits-modal').style.display = 'none';
      });

      // Habits management (in modal)
      document.getElementById('add-habit-btn').addEventListener('click', handleAddHabit);
      document.getElementById('new-habit-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleAddHabit();
      });

      // Click on habits card to manage
      document.getElementById('habits-card')?.addEventListener('click', (e) => {
        if (e.target.closest('#habits-checklist') || e.target.closest('#habits-empty')) {
          document.getElementById('manage-habits-modal').style.display = 'flex';
          renderHabitsList();
        }
      });

      // History modals
      document.getElementById('close-modal').addEventListener('click', () => {
        document.getElementById('history-modal').style.display = 'none';
      });
      document.getElementById('close-edit-modal').addEventListener('click', () => {
        document.getElementById('edit-modal').style.display = 'none';
      });
      document.getElementById('edit-entry-btn').addEventListener('click', openEditModal);
      document.getElementById('save-edit-btn').addEventListener('click', saveEditEntry);

      // Habit edit modal
      document.getElementById('close-habit-modal').addEventListener('click', () => {
        document.getElementById('habit-edit-modal').style.display = 'none';
      });
      document.getElementById('save-habit-edit-btn').addEventListener('click', saveHabitEdit);
      document.getElementById('delete-habit-btn').addEventListener('click', deleteHabitConfirm);

      // Edit modal mood slider
      document.getElementById('edit-mood-input').addEventListener('input', (e) => {
        document.getElementById('edit-mood-value').textContent = e.target.value;
      });

      // Welcome modal
      document.getElementById('save-name-btn').addEventListener('click', saveUserName);
      document.getElementById('user-name-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') saveUserName();
      });

      // Mood prompt modal
      document.getElementById('mood-prompt-input').addEventListener('input', (e) => {
        const value = e.target.value;
        document.getElementById('mood-prompt-value').textContent = value;
        updateMoodBar('mood-prompt-bar', 'mood-prompt-bar-fill', value);
      });
      
      // Initialize mood prompt bar on open
      const moodPromptInput = document.getElementById('mood-prompt-input');
      if (moodPromptInput) {
        updateMoodBar('mood-prompt-bar', 'mood-prompt-bar-fill', moodPromptInput.value);
      }
      document.getElementById('save-mood-prompt-btn').addEventListener('click', saveMoodPrompt);
      document.getElementById('skip-mood-btn').addEventListener('click', () => {
        document.getElementById('mood-prompt-modal').style.display = 'none';
      });

      // Top habits settings
      document.getElementById('top-habits-settings-btn').addEventListener('click', () => {
        const card = document.getElementById('top-habits-settings-card');
        card.style.display = card.style.display === 'none' ? 'block' : 'none';
        if (card.style.display === 'block') {
          loadTopHabitsSelection();
        }
      });
      document.getElementById('save-top-habits-btn').addEventListener('click', saveTopHabits);

      // Settings
      document.getElementById('export-btn').addEventListener('click', handleExportData);
      document.getElementById('import-btn').addEventListener('click', () => {
        document.getElementById('import-file').click();
      });
      document.getElementById('import-file').addEventListener('change', handleImportData);
      document.getElementById('reset-btn').addEventListener('click', resetDataConfirm);
      document.getElementById('save-config-url-btn').addEventListener('click', saveConfigUrl);
      
      // Preferences
      document.getElementById('pref-screen-time').addEventListener('change', (e) => {
        setPreference('showScreenTime', e.target.checked);
        document.getElementById('screen-time-card').style.display = e.target.checked ? 'block' : 'none';
      });
      document.getElementById('pref-weight').addEventListener('change', (e) => {
        setPreference('showWeight', e.target.checked);
        document.getElementById('weight-card').style.display = e.target.checked ? 'block' : 'none';
        if (e.target.checked) {
          loadStatsPage(); // Reload stats to show weight chart
        } else {
          document.getElementById('weight-chart-card').style.display = 'none';
        }
      });
      document.getElementById('pref-mood-prompt').addEventListener('change', (e) => {
        setPreference('promptMoodOnOpen', e.target.checked);
      });
      document.getElementById('save-settings-name-btn').addEventListener('click', saveSettingsUserName);
      document.getElementById('settings-name-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') saveSettingsUserName();
      });

      // Load saved config URL
      const savedConfigUrl = localStorage.getItem('habit_journal_config_url');
      if (savedConfigUrl) {
        document.getElementById('config-url-input').value = savedConfigUrl;
      }
    }

    async function saveUserName() {
      const name = document.getElementById('user-name-input').value.trim();
      if (!name) {
        alert('Please enter your name');
        return;
      }
      await setPreference('userName', name);
      document.getElementById('welcome-modal').style.display = 'none';
      await updateWelcomeTitle();
      await loadPreferences();
    }

    async function saveSettingsUserName() {
      const name = document.getElementById('settings-name-input').value.trim();
      await setPreference('userName', name);
      await updateWelcomeTitle();
      const statusEl = document.createElement('div');
      statusEl.textContent = 'Name saved!';
      statusEl.className = 'save-status success';
      statusEl.style.marginTop = '12px';
      document.getElementById('save-settings-name-btn').parentElement.appendChild(statusEl);
      setTimeout(() => statusEl.remove(), 2000);
    }

    async function saveMoodPrompt() {
      const mood = parseInt(document.getElementById('mood-prompt-input').value);
      const today = getTodayDate();
      const entry = await getEntry(today) || {};
      await saveEntry(today, {
        ...entry,
        mood: mood
      });
      document.getElementById('mood-prompt-modal').style.display = 'none';
      await loadTodayPage(); // Refresh today page
    }

    // Initialize mood bars when modals open
    const moodPromptModal = document.getElementById('mood-prompt-modal');
    if (moodPromptModal) {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
            const isVisible = moodPromptModal.style.display === 'flex';
            if (isVisible) {
              const value = document.getElementById('mood-prompt-input').value;
              updateMoodBar('mood-prompt-bar', 'mood-prompt-bar-fill', value);
            }
          }
        });
      });
      observer.observe(moodPromptModal, { attributes: true });
    }

    function switchTab(tabName) {
      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });

      // Show selected tab
      const tabElement = document.getElementById(`${tabName}-tab`);
      if (tabElement) {
        tabElement.classList.add('active');
      }

      // Update tab bar
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });

      // Load tab-specific content
      if (tabName === 'today') {
        loadTodayPage();
      } else if (tabName === 'stats') {
        loadStatsPage();
      } else if (tabName === 'history') {
        loadHistoryPage();
      }
    }

    function updateTabBar() {
      // Ensure tab bar is visible
      document.querySelector('.tab-bar').style.display = 'flex';
    }

    // Today page
    async function loadTodayPage() {
      const today = getTodayDate();
      document.getElementById('today-date').textContent = formatDate(today);

      // Load existing entry
      const entry = await getEntry(today);
      const prefs = await getPreferences();
      
      if (entry) {
        document.getElementById('mood-input').value = entry.mood || 5;
        document.getElementById('mood-value').textContent = entry.mood || 5;
        updateMoodBar('mood-bar', 'mood-bar-fill', entry.mood || 5);
        document.getElementById('highlight-input').value = entry.highlight || '';
        document.getElementById('journal-input').value = entry.journal || '';
        document.getElementById('screen-time-input').value = entry.screenTime || '';
        document.getElementById('weight-input').value = entry.weight || '';
      } else {
        document.getElementById('mood-input').value = 5;
        document.getElementById('mood-value').textContent = '5';
        updateMoodBar('mood-bar', 'mood-bar-fill', 5);
        document.getElementById('highlight-input').value = '';
        document.getElementById('journal-input').value = '';
        document.getElementById('screen-time-input').value = '';
        document.getElementById('weight-input').value = '';
      }

      // Show habits card if enabled
      if (prefs.showHabits) {
        document.getElementById('habits-card').style.display = 'block';
        await loadHabitsChecklist('habits-checklist', entry?.habitCompletions || {});
      } else {
        document.getElementById('habits-card').style.display = 'none';
      }
    }

    function updateMoodBar(barId, fillId, value) {
      const percentage = ((value - 1) / 9) * 100;
      const fill = document.getElementById(fillId);
      if (fill) {
        fill.style.width = percentage + '%';
      }
    }

    function debounceSave() {
      if (saveTimeout) {
        clearTimeout(saveTimeout);
      }
      saveTimeout = setTimeout(() => {
        saveTodayEntry();
      }, 1000); // Auto-save after 1 second of no input
    }

    async function loadHabitsChecklist(containerId, completions = {}) {
      const container = document.getElementById(containerId);
      const habits = await getHabits();

      if (habits.length === 0) {
        if (containerId === 'habits-checklist') {
          document.getElementById('habits-empty').style.display = 'block';
        }
        container.innerHTML = '';
        return;
      }

      if (containerId === 'habits-checklist') {
        document.getElementById('habits-empty').style.display = 'none';
      }

      container.innerHTML = habits.map(habit => `
        <label class="habit-checkbox">
          <input type="checkbox" data-habit-id="${habit.id}" ${completions[habit.id] ? 'checked' : ''} />
          <span>${escapeHtml(habit.name)}</span>
        </label>
      `).join('');

      // Add auto-save to checkboxes if this is the main checklist
      if (containerId === 'habits-checklist') {
        container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
          checkbox.addEventListener('change', debounceSave);
        });
      }
    }

    async function saveTodayEntry() {
      const today = getTodayDate();
      const mood = parseInt(document.getElementById('mood-input').value);
      const highlight = document.getElementById('highlight-input').value.trim();
      const journal = document.getElementById('journal-input').value.trim();
      const screenTime = document.getElementById('screen-time-input').value.trim();
      const screenTimeNum = screenTime ? parseInt(screenTime) : null;
      const weight = document.getElementById('weight-input').value.trim();
      const weightNum = weight ? parseFloat(weight) : null;

      // Get habit completions
      const habitCompletions = {};
      document.querySelectorAll('#habits-checklist input[type="checkbox"]').forEach(checkbox => {
        habitCompletions[parseInt(checkbox.dataset.habitId)] = checkbox.checked;
      });

      try {
        await saveEntry(today, {
          mood,
          highlight,
          journal,
          screenTime: screenTimeNum,
          weight: weightNum,
          habitCompletions
        });

        const statusEl = document.getElementById('save-status');
        statusEl.textContent = 'Saved';
        statusEl.className = 'save-status success';
        setTimeout(() => {
          statusEl.textContent = '';
          statusEl.className = 'save-status';
        }, 1500);
      } catch (error) {
        console.error('Failed to save entry:', error);
        const statusEl = document.getElementById('save-status');
        statusEl.textContent = 'Save failed';
        statusEl.className = 'save-status error';
        setTimeout(() => {
          statusEl.textContent = '';
          statusEl.className = 'save-status';
        }, 2000);
      }
    }


    async function renderHabitsList() {
      const container = document.getElementById('habits-list');
      const emptyState = document.getElementById('habits-list-empty');
      const habits = await getHabits();

      if (habits.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      container.innerHTML = habits.map(habit => `
        <div class="habit-item">
          <span class="habit-name">${escapeHtml(habit.name)}</span>
          <button class="edit-habit-btn" data-habit-id="${habit.id}">Edit</button>
        </div>
      `).join('');

      // Add edit listeners
      document.querySelectorAll('.edit-habit-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const habitId = parseInt(btn.dataset.habitId);
          openHabitEditModal(habitId);
        });
      });
    }

    async function handleAddHabit() {
      const input = document.getElementById('new-habit-input');
      const name = input.value.trim();

      if (!name) {
        alert('Please enter a habit name');
        return;
      }

      try {
        await addHabit(name);
        input.value = '';
        await renderHabitsList();
        // Reload checklist on Today page if it's visible
        if (document.getElementById('today-tab').classList.contains('active')) {
          const entry = await getEntry(getTodayDate());
          await loadHabitsChecklist('habits-checklist', entry?.habitCompletions || {});
        }
      } catch (error) {
        alert('Failed to add habit: ' + error.message);
      }
    }

    async function openHabitEditModal(habitId) {
      currentEditingHabitId = habitId;
      const habits = await getHabits();
      const habit = habits.find(h => h.id === habitId);

      if (habit) {
        document.getElementById('edit-habit-name-input').value = habit.name;
        document.getElementById('habit-edit-modal').style.display = 'block';
      }
    }

    async function saveHabitEdit() {
      const name = document.getElementById('edit-habit-name-input').value.trim();

      if (!name) {
        alert('Please enter a habit name');
        return;
      }

      try {
        await updateHabit(currentEditingHabitId, name);
        document.getElementById('habit-edit-modal').style.display = 'none';
        await renderHabitsList();
        // Reload checklist on Today page if it's visible
        if (document.getElementById('today-tab').classList.contains('active')) {
          const entry = await getEntry(getTodayDate());
          await loadHabitsChecklist('habits-checklist', entry?.habitCompletions || {});
        }
      } catch (error) {
        alert('Failed to update habit: ' + error.message);
      }
    }

    async function deleteHabitConfirm() {
      if (confirm('Are you sure you want to delete this habit? This will remove it from all entries.')) {
        try {
          await deleteHabit(currentEditingHabitId);
          document.getElementById('habit-edit-modal').style.display = 'none';
          await renderHabitsList();
          // Reload checklist on Today page if it's visible
          if (document.getElementById('today-tab').classList.contains('active')) {
            const entry = await getEntry(getTodayDate());
            await loadHabitsChecklist('habits-checklist', entry?.habitCompletions || {});
          }
        } catch (error) {
          alert('Failed to delete habit: ' + error.message);
        }
      }
    }

    // Stats page
    async function loadStatsPage() {
      await renderHabitStats();
      await renderMoodChart();
      await renderWeightChart();
      await renderJournalConsistency();
      await renderMostConsistentHabits();
    }

    async function renderHabitStats() {
      const container = document.getElementById('habit-stats-container');
      const habits = await getHabits();

      if (habits.length === 0) {
        container.innerHTML = '<p>No habits to display stats for.</p>';
        return;
      }

      const statsHtml = await Promise.all(habits.map(async (habit) => {
        const stats7d = await calculateHabitStats(habit.id, 7);
        const stats30d = await calculateHabitStats(habit.id, 30);
        const statsAll = await calculateHabitStats(habit.id, 9999);
        const streak = await calculateHabitStreak(habit.id);

        return `
          <div class="habit-stat-item">
            <h3>${escapeHtml(habit.name)}</h3>
            <div class="stat-row">
              <span>7 days:</span>
              <span>${stats7d.completed}/${stats7d.total} (${stats7d.rate}%)</span>
            </div>
            <div class="stat-row">
              <span>30 days:</span>
              <span>${stats30d.completed}/${stats30d.total} (${stats30d.rate}%)</span>
            </div>
            <div class="stat-row">
              <span>All time:</span>
              <span>${statsAll.completed}/${statsAll.total} (${statsAll.rate}%)</span>
            </div>
            <div class="stat-row">
              <span>Current streak:</span>
              <span>${streak.current} days</span>
            </div>
            <div class="stat-row">
              <span>Longest streak:</span>
              <span>${streak.longest} days</span>
            </div>
          </div>
        `;
      }));

      container.innerHTML = statsHtml.join('');
    }

    async function renderMoodChart() {
      const moodData = await getMoodTrend(30);
      const ctx = document.getElementById('mood-chart').getContext('2d');

      if (moodChart) {
        moodChart.destroy();
      }

      if (moodData.length === 0) {
        document.getElementById('mood-chart').parentElement.innerHTML = '<p>No mood data available yet.</p>';
        return;
      }

      moodChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: moodData.map(d => formatDateShort(d.date)),
          datasets: [{
            label: 'Mood',
            data: moodData.map(d => d.mood),
            borderColor: '#007AFF',
            backgroundColor: 'rgba(0, 122, 255, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1.5,
          scales: {
            y: {
              beginAtZero: false,
              min: 1,
              max: 10,
              ticks: {
                stepSize: 1
              }
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    async function renderWeightChart() {
      const prefs = await getPreferences();
      if (!prefs.showWeight) {
        document.getElementById('weight-chart-card').style.display = 'none';
        return;
      }

      const weightData = await getWeightTrend(30);
      const ctx = document.getElementById('weight-chart');
      if (!ctx) return;

      if (weightChart) {
        weightChart.destroy();
      }

      if (weightData.length === 0) {
        document.getElementById('weight-chart-card').style.display = 'none';
        return;
      }

      document.getElementById('weight-chart-card').style.display = 'block';
      const chartCtx = ctx.getContext('2d');

      weightChart = new Chart(chartCtx, {
        type: 'line',
        data: {
          labels: weightData.map(d => formatDateShort(d.date)),
          datasets: [{
            label: 'Weight (lbs)',
            data: weightData.map(d => d.weight),
            borderColor: '#34C759',
            backgroundColor: 'rgba(52, 199, 89, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          aspectRatio: 1.5,
          scales: {
            y: {
              beginAtZero: false
            }
          },
          plugins: {
            legend: {
              display: false
            }
          }
        }
      });
    }

    async function renderJournalConsistency() {
      const consistency = await getJournalConsistency();
      const container = document.getElementById('journal-consistency');
      const rate = consistency.total > 0 ? Math.round((consistency.journaled / consistency.total) * 100) : 0;

      container.innerHTML = `
        <div class="stat-row">
          <span>Days journaled:</span>
          <span>${consistency.journaled} / ${consistency.total}</span>
        </div>
        <div class="stat-row">
          <span>Consistency rate:</span>
          <span>${rate}%</span>
        </div>
      `;
    }

    async function renderMostConsistentHabits() {
      const topHabits = await getMostConsistentHabits();
      const container = document.getElementById('most-consistent-habits');

      if (topHabits.length === 0) {
        container.innerHTML = '<p>No habit data available yet.</p>';
        return;
      }

      container.innerHTML = topHabits.map((item, index) => `
        <div class="stat-row">
          <span>${index + 1}. ${escapeHtml(item.habit.name)}</span>
          <span>${item.rate}% (30 days)</span>
        </div>
      `).join('');
    }

    // History page
    async function loadHistoryPage() {
      const entries = await getAllEntries();
      const container = document.getElementById('history-list');
      const emptyState = document.getElementById('history-empty');

      if (entries.length === 0) {
        container.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      const sortedEntries = entries.sort((a, b) => b.date.localeCompare(a.date));
      
      // Load top habits
      const prefs = await getPreferences();
      topHabits = prefs.topHabits || [null, null, null];

      container.innerHTML = sortedEntries.map(entry => {
        const completions = entry.habitCompletions || {};
        const habitBoxes = topHabits.map((habitId, index) => {
          if (!habitId) return '<div class="habit-box empty">-</div>';
          const completed = completions[habitId];
          return `<div class="habit-box ${completed ? 'completed' : ''}">${completed ? '‚úì' : ''}</div>`;
        }).join('');

        return `
          <div class="history-row" data-date="${entry.date}">
            <div class="history-date-col">${formatDateShort(entry.date)}</div>
            <div class="history-mood-col">${entry.mood ? `${entry.mood}/10` : '-'}</div>
            <div class="history-habits-col">${habitBoxes}</div>
          </div>
        `;
      }).join('');

      // Add click listeners
      document.querySelectorAll('.history-row').forEach(item => {
        item.addEventListener('click', () => {
          const date = item.dataset.date;
          openHistoryModal(date);
        });
      });
    }

    async function loadTopHabitsSelection() {
      const habits = await getHabits();
      const prefs = await getPreferences();
      const selected = prefs.topHabits || [null, null, null];
      const container = document.getElementById('top-habits-selection');

      if (habits.length === 0) {
        container.innerHTML = '<p>No habits available. Add habits first!</p>';
        return;
      }

      container.innerHTML = [0, 1, 2].map(index => {
        const selectedId = selected[index];
        const selectedHabit = habits.find(h => h.id === selectedId);
        
        return `
          <div class="top-habit-selector">
            <label>Habit ${index + 1}:</label>
            <select class="top-habit-select" data-index="${index}">
              <option value="">None</option>
              ${habits.map(h => `
                <option value="${h.id}" ${h.id === selectedId ? 'selected' : ''}>${escapeHtml(h.name)}</option>
              `).join('')}
            </select>
          </div>
        `;
      }).join('');

      document.querySelectorAll('.top-habit-select').forEach(select => {
        select.addEventListener('change', (e) => {
          const index = parseInt(e.target.dataset.index);
          const habitId = e.target.value ? parseInt(e.target.value) : null;
          topHabits[index] = habitId;
        });
      });
    }

    async function saveTopHabits() {
      await setPreference('topHabits', topHabits);
      document.getElementById('top-habits-settings-card').style.display = 'none';
      await loadHistoryPage();
    }

    async function openHistoryModal(date) {
      const entry = await getEntry(date);
      if (!entry) return;

      document.getElementById('modal-date').textContent = formatDate(date);
      document.getElementById('modal-mood').textContent = entry.mood ? `${entry.mood}/10` : 'Not set';
      document.getElementById('modal-highlight').textContent = entry.highlight || 'None';
      document.getElementById('modal-journal').textContent = entry.journal || 'No journal entry';
      document.getElementById('modal-screen-time').textContent = entry.screenTime ? `${entry.screenTime} minutes` : 'Not set';
      
      // Add weight to modal if it exists
      const modalBody = document.querySelector('#history-modal .modal-body');
      let weightDiv = document.getElementById('modal-weight');
      if (!weightDiv && entry.weight) {
        weightDiv = document.createElement('div');
        weightDiv.className = 'card';
        weightDiv.id = 'modal-weight';
        weightDiv.innerHTML = '<label>Weight</label><div id="modal-weight-value"></div>';
        modalBody.insertBefore(weightDiv, document.getElementById('modal-screen-time').parentElement.nextSibling);
      }
      if (weightDiv) {
        document.getElementById('modal-weight-value').textContent = entry.weight ? `${entry.weight} lbs` : 'Not set';
      }

      // Load habits for this entry
      const habits = await getHabits();
      const completions = entry.habitCompletions || {};
      const habitsHtml = habits.length > 0
        ? habits.map(h => `<div>${completions[h.id] ? '‚úì' : '‚óã'} ${escapeHtml(h.name)}</div>`).join('')
        : '<div>No habits</div>';
      document.getElementById('modal-habits').innerHTML = habitsHtml;

      currentEditingDate = date;
      document.getElementById('history-modal').style.display = 'block';
    }

    async function openEditModal() {
      document.getElementById('history-modal').style.display = 'none';
      const entry = await getEntry(currentEditingDate);
      if (!entry) return;

      document.getElementById('edit-modal-date').textContent = formatDate(currentEditingDate);
      document.getElementById('edit-mood-input').value = entry.mood || 5;
      document.getElementById('edit-mood-value').textContent = entry.mood || 5;
      document.getElementById('edit-highlight-input').value = entry.highlight || '';
      document.getElementById('edit-journal-input').value = entry.journal || '';
      document.getElementById('edit-screen-time-input').value = entry.screenTime || '';
      
      // Add weight field to edit modal if preference is enabled
      const prefs = await getPreferences();
      let weightInput = document.getElementById('edit-weight-input');
      if (prefs.showWeight) {
        if (!weightInput) {
          const weightCard = document.createElement('div');
          weightCard.className = 'card';
          weightCard.innerHTML = `
            <label for="edit-weight-input">Weight (lbs)</label>
            <input type="number" id="edit-weight-input" min="0" step="0.1" />
          `;
          const editBody = document.querySelector('#edit-modal .modal-body');
          editBody.insertBefore(weightCard, document.getElementById('edit-screen-time-input').parentElement.nextSibling);
          weightInput = document.getElementById('edit-weight-input');
        }
        weightInput.value = entry.weight || '';
      } else if (weightInput) {
        weightInput.parentElement.remove();
      }

      await loadHabitsChecklist('edit-habits-checklist', entry.habitCompletions || {});
      document.getElementById('edit-modal').style.display = 'block';
    }

    async function saveEditEntry() {
      const mood = parseInt(document.getElementById('edit-mood-input').value);
      const highlight = document.getElementById('edit-highlight-input').value.trim();
      const journal = document.getElementById('edit-journal-input').value.trim();
      const screenTime = document.getElementById('edit-screen-time-input').value.trim();
      const screenTimeNum = screenTime ? parseInt(screenTime) : null;
      const weightInput = document.getElementById('edit-weight-input');
      const weight = weightInput ? weightInput.value.trim() : '';
      const weightNum = weight ? parseFloat(weight) : null;

      // Get habit completions
      const habitCompletions = {};
      document.querySelectorAll('#edit-habits-checklist input[type="checkbox"]').forEach(checkbox => {
        habitCompletions[parseInt(checkbox.dataset.habitId)] = checkbox.checked;
      });

      try {
        await saveEntry(currentEditingDate, {
          mood,
          highlight,
          journal,
          screenTime: screenTimeNum,
          weight: weightNum,
          habitCompletions
        });

        document.getElementById('edit-modal').style.display = 'none';
        await loadHistoryPage();
        if (currentEditingDate === getTodayDate()) {
          await loadTodayPage();
        }
      } catch (error) {
        alert('Failed to save entry: ' + error.message);
      }
    }

    // Settings page
    async function handleExportData() {
      try {
        const data = await exportData();
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `habit-journal-export-${getTodayDate()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (error) {
        alert('Failed to export data: ' + error.message);
      }
    }

    async function handleImportData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const json = JSON.parse(e.target.result);
          await importData(json);
          document.getElementById('import-status').textContent = 'Import successful!';
          document.getElementById('import-status').className = 'save-status success';
          
          // Reload all pages
          await loadTodayPage();
          await loadHabitsPage();
          await loadStatsPage();
          await loadHistoryPage();
          
          setTimeout(() => {
            document.getElementById('import-status').textContent = '';
            document.getElementById('import-status').className = 'save-status';
          }, 3000);
        } catch (error) {
          document.getElementById('import-status').textContent = 'Import failed: ' + error.message;
          document.getElementById('import-status').className = 'save-status error';
        }
      };
      reader.readAsText(file);
      event.target.value = ''; // Reset file input
    }

    async function resetDataConfirm() {
      if (confirm('Are you sure you want to delete ALL data? This cannot be undone!')) {
        if (confirm('This will permanently delete all habits and entries. Continue?')) {
          try {
            // Delete database
            indexedDB.deleteDatabase(DB_NAME);
            // Reload page
            location.reload();
          } catch (error) {
            alert('Failed to reset data: ' + error.message);
          }
        }
      }
    }

    function saveConfigUrl() {
      const url = document.getElementById('config-url-input').value.trim();
      localStorage.setItem('habit_journal_config_url', url);
      const statusEl = document.getElementById('config-url-status');
      statusEl.textContent = 'URL saved!';
      statusEl.className = 'save-status success';
      setTimeout(() => {
        statusEl.textContent = '';
        statusEl.className = 'save-status';
      }, 2000);
    }

    // Utility
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize on load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
